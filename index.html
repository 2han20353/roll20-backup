
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Roll20 → 티스토리 변환기</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
    }
    #editor {
      border: 2px dashed #999;
      padding: 10px;
      min-height: 300px;
      max-height: 500px;
      overflow: auto;
    }
    textarea {
      width: 100%;
      height: 200px;
    }
    .image-block {
      margin-bottom: 1rem;
    }
    .image-block img {
      max-width: 150px;
      display: block;
      margin-bottom: 5px;
    }
    .image-block input {
      width: 100%;
    }
    #imageInputs {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>Roll20 → 티스토리 변환기</h1>
  <p>HTML 채팅 로그를 아래에 붙여넣고, 숨김 메시지를 정리하거나 이미지 링크를 교체하세요.</p>
  <div id="editor" contenteditable="true"></div>
  <br />
  <button onclick="cleanHiddenMessages()">정리하기 (숨김 메시지 제거)</button>
  <button onclick="replaceImages()">이미지 교체하기</button>

  <div id="imageInputs"></div>

  <h3>결과 미리보기</h3>
  <div id="preview" style="border:1px solid #ccc; padding:10px; max-height:400px; overflow:auto;"></div>

  <h3>복사용 HTML 코드</h3>
  <textarea id="output" readonly></textarea>

  <script>
    function cleanHiddenMessages() {
      const editor = document.getElementById("editor");
      const doc = document.createElement("div");
      doc.innerHTML = editor.innerHTML;
      const hiddenMessages = doc.querySelectorAll("div.hidden-message");
      hiddenMessages.forEach(div => div.remove());
      editor.innerHTML = doc.innerHTML;
      updatePreview();
    }

    function replaceImages() {
      const editor = document.getElementById("editor");
      const doc = document.createElement("div");
      doc.innerHTML = editor.innerHTML;
      const imageInputs = document.getElementById("imageInputs");
      imageInputs.innerHTML = "";

      const allElements = [...doc.querySelectorAll("img, [style*='files.d20.io/images']")];
      const groups = {};

      allElements.forEach(el => {
        let url = "";
        if (el.tagName === "IMG") {
          url = el.src;
        } else {
          const bg = el.style.backgroundImage;
          const match = bg.match(/url\(["']?(.*?)["']?\)/);
          if (match) url = match[1];
        }

        if (url) {
          if (!groups[url]) groups[url] = [];
          groups[url].push(el);
        }
      });

      Object.keys(groups).forEach(url => {
        const div = document.createElement("div");
        div.className = "image-block";

        const preview = document.createElement("img");
        preview.src = url;

        const input = document.createElement("input");
        input.value = url;
        input.placeholder = "새 이미지 주소 입력";

        input.addEventListener("input", () => {
          const newURL = input.value;
          preview.src = newURL;
          groups[url].forEach(el => {
            if (el.tagName === "IMG") {
              el.src = newURL;
            } else {
              el.style.backgroundImage = `url("${newURL}")`;
            }
          });
          updatePreview(doc.innerHTML);
        });

        div.appendChild(preview);
        div.appendChild(input);
        imageInputs.appendChild(div);
      });

      editor.innerHTML = doc.innerHTML;
      updatePreview();
    }

    function updatePreview(forcedHTML) {
      const editor = document.getElementById("editor");
      const html = forcedHTML || editor.innerHTML;
      document.getElementById("preview").innerHTML = html;
      document.getElementById("output").value = html;
    }
  </script>
</body>
</html>
